2021-01-26 20:17:03 0 [Note] /test/UBASAN_MD301120-mariadb-10.6.0-linux-x86_64-dbg/bin/mysqld: ready for connections.
Version: '10.6.0-MariaDB-debug'  socket: '/test/UBASAN_MD301120-mariadb-10.6.0-linux-x86_64-dbg/socket.sock'  port: 11155  MariaDB Server
2021-01-26 20:22:24 5 [Note] Event Scheduler: scheduler thread started with id 5
=================================================================
==3119492==ERROR: AddressSanitizer: heap-use-after-free on address 0x611000050f40 at pc 0x5574446306ad bp 0x1460109c1190 sp 0x1460109c1180
READ of size 8 at 0x611000050f40 thread T15
    #0 0x5574446306ac in event_queue_element_compare_q /test/10.6_dbg_san/sql/event_queue.cc:75
    #1 0x5574464b52f0 in insert_at /test/10.6_dbg_san/mysys/queues.c:191
    #2 0x5574464b6333 in queue_insert /test/10.6_dbg_san/mysys/queues.c:219
    #3 0x5574464b650a in queue_insert_safe /test/10.6_dbg_san/mysys/queues.c:248
    #4 0x557444634609 in Event_queue::update_event(THD*, st_mysql_const_lex_string const*, st_mysql_const_lex_string const*, Event_queue_element*) /test/10.6_dbg_san/sql/event_queue.cc:271
    #5 0x55744264b857 in Events::update_event(THD*, Event_parse_data*, st_mysql_const_lex_string*, st_mysql_const_lex_string*) /test/10.6_dbg_san/sql/events.cc:550
    #6 0x557441da5499 in mysql_execute_command(THD*) /test/10.6_dbg_san/sql/sql_parse.cc:5132
    #7 0x557441cf150e in mysql_parse(THD*, char*, unsigned int, Parser_state*) /test/10.6_dbg_san/sql/sql_parse.cc:7883
    #8 0x557441d5ffec in dispatch_command(enum_server_command, THD*, char*, unsigned int) /test/10.6_dbg_san/sql/sql_parse.cc:1816
    #9 0x557441d753b4 in do_command(THD*) /test/10.6_dbg_san/sql/sql_parse.cc:1348
    #10 0x557442754f1a in do_handle_one_connection(CONNECT*, bool) /test/10.6_dbg_san/sql/sql_connect.cc:1410
    #11 0x55744275819d in handle_one_connection /test/10.6_dbg_san/sql/sql_connect.cc:1312
    #12 0x557444c5442d in pfs_spawn_thread /test/10.6_dbg_san/storage/perfschema/pfs.cc:2201
    #13 0x146033b56608 in start_thread /build/glibc-ZN95T4/glibc-2.31/nptl/pthread_create.c:477
    #14 0x146032caa292 in __clone (/lib/x86_64-linux-gnu/libc.so.6+0x122292)
 
0x611000050f40 is located 0 bytes inside of 208-byte region [0x611000050f40,0x611000051010)
freed by thread T15 here:
    #0 0x5574414ce31f in operator delete(void*) (/test/UBASAN_MD301120-mariadb-10.6.0-linux-x86_64-dbg/bin/mariadbd+0x809031f)
    #1 0x55744262ba5e in Event_queue_element::~Event_queue_element() /test/10.6_dbg_san/sql/event_data_objects.cc:331
    #2 0x557444631a11 in Event_queue::find_n_remove_event(st_mysql_const_lex_string const*, st_mysql_const_lex_string const*) /test/10.6_dbg_san/sql/event_queue.cc:430
    #3 0x55744463459e in Event_queue::update_event(THD*, st_mysql_const_lex_string const*, st_mysql_const_lex_string const*, Event_queue_element*) /test/10.6_dbg_san/sql/event_queue.cc:265
    #4 0x55744264b857 in Events::update_event(THD*, Event_parse_data*, st_mysql_const_lex_string*, st_mysql_const_lex_string*) /test/10.6_dbg_san/sql/events.cc:550
    #5 0x557441da5499 in mysql_execute_command(THD*) /test/10.6_dbg_san/sql/sql_parse.cc:5132
    #6 0x557441cf150e in mysql_parse(THD*, char*, unsigned int, Parser_state*) /test/10.6_dbg_san/sql/sql_parse.cc:7883
    #7 0x557441d5ffec in dispatch_command(enum_server_command, THD*, char*, unsigned int) /test/10.6_dbg_san/sql/sql_parse.cc:1816
    #8 0x557441d753b4 in do_command(THD*) /test/10.6_dbg_san/sql/sql_parse.cc:1348
    #9 0x557442754f1a in do_handle_one_connection(CONNECT*, bool) /test/10.6_dbg_san/sql/sql_connect.cc:1410
    #10 0x55744275819d in handle_one_connection /test/10.6_dbg_san/sql/sql_connect.cc:1312
    #11 0x557444c5442d in pfs_spawn_thread /test/10.6_dbg_san/storage/perfschema/pfs.cc:2201
    #12 0x146033b56608 in start_thread /build/glibc-ZN95T4/glibc-2.31/nptl/pthread_create.c:477
 
previously allocated by thread T15 here:
    #0 0x5574414cd387 in operator new(unsigned long) (/test/UBASAN_MD301120-mariadb-10.6.0-linux-x86_64-dbg/bin/mariadbd+0x808f387)
    #1 0x557442649883 in Events::create_event(THD*, Event_parse_data*) /test/10.6_dbg_san/sql/events.cc:372
    #2 0x557441da5566 in mysql_execute_command(THD*) /test/10.6_dbg_san/sql/sql_parse.cc:5128
    #3 0x557441cf150e in mysql_parse(THD*, char*, unsigned int, Parser_state*) /test/10.6_dbg_san/sql/sql_parse.cc:7883
    #4 0x557441d5ffec in dispatch_command(enum_server_command, THD*, char*, unsigned int) /test/10.6_dbg_san/sql/sql_parse.cc:1816
    #5 0x557441d753b4 in do_command(THD*) /test/10.6_dbg_san/sql/sql_parse.cc:1348
    #6 0x557442754f1a in do_handle_one_connection(CONNECT*, bool) /test/10.6_dbg_san/sql/sql_connect.cc:1410
    #7 0x55744275819d in handle_one_connection /test/10.6_dbg_san/sql/sql_connect.cc:1312
    #8 0x557444c5442d in pfs_spawn_thread /test/10.6_dbg_san/storage/perfschema/pfs.cc:2201
    #9 0x146033b56608 in start_thread /build/glibc-ZN95T4/glibc-2.31/nptl/pthread_create.c:477
 
Thread T15 created by T0 here:
    #0 0x5574413f8275 in __interceptor_pthread_create (/test/UBASAN_MD301120-mariadb-10.6.0-linux-x86_64-dbg/bin/mariadbd+0x7fba275)
    #1 0x557444c64f45 in my_thread_create /test/10.6_dbg_san/storage/perfschema/my_thread.h:38
    #2 0x557444c64f45 in pfs_spawn_thread_v1 /test/10.6_dbg_san/storage/perfschema/pfs.cc:2252
    #3 0x55744152630d in inline_mysql_thread_create /test/10.6_dbg_san/include/mysql/psi/mysql_thread.h:1323
    #4 0x55744152630d in create_thread_to_handle_connection(CONNECT*) /test/10.6_dbg_san/sql/mysqld.cc:5804
    #5 0x557441539d9b in create_new_thread(CONNECT*) /test/10.6_dbg_san/sql/mysqld.cc:5863
    #6 0x55744153a3d0 in handle_accepted_socket(st_mysql_socket, st_mysql_socket) /test/10.6_dbg_san/sql/mysqld.cc:5928
    #7 0x55744153be54 in handle_connections_sockets() /test/10.6_dbg_san/sql/mysqld.cc:6055
    #8 0x55744153f966 in mysqld_main(int, char**) /test/10.6_dbg_san/sql/mysqld.cc:5699
    #9 0x55744150cbba in main /test/10.6_dbg_san/sql/main.cc:25
    #10 0x146032baf0b2 in __libc_start_main (/lib/x86_64-linux-gnu/libc.so.6+0x270b2)
 
SUMMARY: AddressSanitizer: heap-use-after-free /test/10.6_dbg_san/sql/event_queue.cc:75 in event_queue_element_compare_q
Shadow bytes around the buggy address:
  0x0c2280002190: fa fa fa fa fa fa fa fa 00 00 00 00 00 00 00 00
  0x0c22800021a0: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
  0x0c22800021b0: 04 fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa
  0x0c22800021c0: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
  0x0c22800021d0: 00 00 00 00 00 00 00 00 04 fa fa fa fa fa fa fa
=>0x0c22800021e0: fa fa fa fa fa fa fa fa[fd]fd fd fd fd fd fd fd
  0x0c22800021f0: fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd
  0x0c2280002200: fd fd fa fa fa fa fa fa fa fa fa fa fa fa fa fa
  0x0c2280002210: fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd
  0x0c2280002220: fd fd fd fd fd fd fd fd fd fd fa fa fa fa fa fa
  0x0c2280002230: fa fa fa fa fa fa fa fa 00 00 00 00 00 00 00 00
Shadow byte legend (one shadow byte represents 8 application bytes):
  Addressable:           00
  Partially addressable: 01 02 03 04 05 06 07
  Heap left redzone:       fa
  Freed heap region:       fd
  Stack left redzone:      f1
  Stack mid redzone:       f2
  Stack right redzone:     f3
  Stack after return:      f5
  Stack use after scope:   f8
  Global redzone:          f9
  Global init order:       f6
  Poisoned by user:        f7
  Container overflow:      fc
  Array cookie:            ac
  Intra object redzone:    bb
  ASan internal:           fe
  Left alloca redzone:     ca
  Right alloca redzone:    cb
  Shadow gap:              cc
==3119492==ABORTING
210126 20:22:25 [ERROR] mysqld got signal 6 ;
...
Query (0x62b0000a12a8): ALTER EVENT e ON SCHEDULE EVERY 1 HOUR STARTS '1999-01-01 00:00:00'
