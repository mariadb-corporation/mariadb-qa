#!/bin/bash
# Created by Roel Van de Paar, MariaDB

# User variables
THREADS=3  # Number of threads use in xargs -P{threads}: note that >3 threads may cause crashes like 'SIGABRT|Diagnostics_area::set_ok_status|my_ok|mysql_rm_table|mysql_execute_command', thereby leading to a partially incorrect bug report output (minor errors: some versions showing as not-affected while they are)

# Script variables
SAN_MODE=0
MYEXTRA_OPT="$*"
if [ "${1}" == "SAN" ]; then
  SAN_MODE=1
  MYEXTRA_OPT="$(echo "${MYEXTRA_OPT}" | sed 's|SAN||')"
elif [ "${1}" == "SAN" ]; then
  MYEXTRA_OPT="$(echo "${MYEXTRA_OPT}" | sed 's|GAL||')"
fi

sync

# Stop (if running), wipe and start all instances in parallel
if [ ${SAN_MODE} -eq 1 ]; then
  ./gendirs.sh SAN | xargs -I{} echo "cd {}; ./all_no_cl ${MYEXTRA_OPT}" | xargs -P${THREADS} -I{} bash -c "{}"
elif [ "${1}" == "GAL" ]; then
  ./gendirs.sh GAL | xargs -I{} echo "cd {}; ./gal_no_cl ${MYEXTRA_OPT}" | xargs -P${THREADS} -I{} bash -c "{}"
else
  ./gendirs.sh | xargs -I{} echo "cd {}; ./all_no_cl ${MYEXTRA_OPT}" | xargs -P${THREADS} -I{} bash -c "{}"
fi

sync
