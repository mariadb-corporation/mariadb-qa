#!/bin/bash
# Created by Roel Van de Paar, MariaDB

SAN_MODE=0
MYEXTRA_OPT="$*"
if [ "${1}" == "SAN" ]; then
  SAN_MODE=1
  MYEXTRA_OPT="$(echo "${MYEXTRA_OPT}" | sed 's|SAN||')"
elif [ "${1}" == "SAN" ]; then
  MYEXTRA_OPT="$(echo "${MYEXTRA_OPT}" | sed 's|GAL||')"
fi

# Stop (if running), wipe and start all instances in parallel
if [ ${SAN_MODE} -eq 1 ]; then
  ./gendirs.sh SAN | xargs -I{} echo "cd {}; ./all_no_cl ${MYEXTRA_OPT}" | xargs -P1 -I{} sh -c "{}"  # 1: SAN mode struggles with a high number of threads for starting up servers
elif [ "${1}" == "GAL" ]; then
  ./gendirs.sh GAL | xargs -I{} echo "cd {}; ./gal_no_cl ${MYEXTRA_OPT}" | xargs -P50 -I{} sh -c "{}"
else
  ./gendirs.sh | xargs -I{} echo "cd {}; ./all_no_cl ${MYEXTRA_OPT}" | xargs -P50 -I{} sh -c "{}"
fi

sync
