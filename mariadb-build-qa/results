#!/bin/bash
DIR=/data
source results.list  # This file should contain lines like: 
                     # MON[1]=532099
                     # MON[2]=398230
                     # MON[3]=032309
                     # etc. The file is sourced to allow this file to be backed up with results.list 
                     # being local to the machine/directory. Note: results.list is not backed up
clear
while true; do
  for ((i=1;i<=20;i++)); do
    if [ ! -z "${MON[i]}" ]; then
      if [ -d "${DIR}/${MON[${i}]}" ]; then
        cd "${DIR}/${MON[${i}]}"
        ~/pr | grep -vEi '^================$|SHUTDOWN|no reducer scripts were found in this directory' | sed '/Coredumps found in trials/,+1d'
        ERRORS="$(tail -n1 */*/log/master.err */log/master.err */*/node*/node*.err */node*/node*.err 2>/dev/null | grep --no-group-separator --binary-files=text -B1 -E 'invalid|alloc|free|corruption|corrupted' | grep -vE 'Column count of mysql\.')"  # malloc(): , double free or corruption, free(): , Warning: Memory not freed, etc. 
        if [ ! -z "${ERRORS}" ]; then 
          echo "=== Malloc/free/corruption issues in last line of error logs"
          echo "${ERRORS}"
        fi
      else
        echo "Index ${i} seems to be invalid: directopry ${DIR}/${MON[${i}]} does not exist!"
        exit 1
      fi
    fi
  done
  sleep 60
done
