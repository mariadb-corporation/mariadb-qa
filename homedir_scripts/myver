#!/bin/bash
if [ -d ./mysqld ]; then
  echo "Assert: this does not look to be a BASEDIR but rather a WORKDIR. Please use this script from a BASEDIR only"
  exit 1
elif [ ! -r bin/mysqld -a ! -r ./mysqld ]; then
  echo "Assert: bin/mysqld nor ./mysqld not found!"
  exit 1
fi
if [ -r bin/mysqld ]; then BIN="bin/mysqld"; else BIN="./mysqld"; fi
SOURCE_CODE_REV="$(grep -om1 --binary-files=text "Source control revision id for MariaDB source code[^ ]\+" ${BIN} 2>/dev/null | tr -d '\0' | sed 's|.*source code||;s|Version||;s|version_source_revision||')"
SERVER_VERSION="$(${BIN} --version | grep -om1 '[-0-9\.]\+-MariaDB' | sed 's|-MariaDB||')"
LAST_THREE="$(echo "${PWD}" | sed 's|.*\(...\)$|\1|')"
BUILD_TYPE=
SAN=
SAN="$(echo "${PWD}" | sed 's|.*/||' | grep -o '[UBAT]\+SAN')"
if [ -z "${SAN}" ]; then
  if [ "${LAST_THREE}" == "opt" ]; then BUILD_TYPE=" (Optimized)"; fi
  if [ "${LAST_THREE}" == "dbg" ]; then BUILD_TYPE=" (Debug)"; fi
else
  if [ "${LAST_THREE}" == "opt" ]; then BUILD_TYPE=" (Optimized, ${SAN})"; fi
  if [ "${LAST_THREE}" == "dbg" ]; then BUILD_TYPE=" (Debug, ${SAN})"; fi
fi
echo "{noformat:title=${SERVER_VERSION} ${SOURCE_CODE_REV}${BUILD_TYPE}}"
echo ""
echo "{noformat}"
